# 배포 파이프라인
# main 브랜치 푸시 또는 수동 실행 시 AWS에 배포
name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: '배포 환경'
        required: true
        default: 'dev'
        type: choice
        options:
          - dev
          - prod

env:
  AWS_REGION: ap-northeast-2

jobs:
  deploy-infrastructure:
    name: Deploy Infrastructure (CDK)
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared package
        run: pnpm --filter @baepdoongi/shared build

      - name: Build bot (CDK에서 참조)
        run: pnpm --filter @baepdoongi/bot build

      - name: Deploy CDK stacks
        working-directory: infra
        run: |
          pnpm install --frozen-lockfile
          pnpm cdk deploy --all --require-approval never
        env:
          ENVIRONMENT: ${{ github.event.inputs.environment || 'dev' }}

  deploy-dashboard:
    name: Deploy Dashboard
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    environment: ${{ github.event.inputs.environment || 'dev' }}

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build shared package
        run: pnpm --filter @baepdoongi/shared build

      - name: Build dashboard
        run: pnpm --filter @baepdoongi/dashboard build
        env:
          NEXT_PUBLIC_API_URL: ${{ secrets.API_URL }}

      - name: Get Dashboard bucket name
        id: bucket
        run: |
          BUCKET_NAME=$(aws cloudformation describe-stacks \
            --stack-name BaepdoongiDashboardStack \
            --query "Stacks[0].Outputs[?ExportName=='BaepdoongiDashboardBucketName'].OutputValue" \
            --output text)
          echo "name=$BUCKET_NAME" >> $GITHUB_OUTPUT

      - name: Deploy to S3
        run: |
          # Next.js static export 사용 시
          aws s3 sync packages/dashboard/out/ s3://${{ steps.bucket.outputs.name }} \
            --delete \
            --cache-control "max-age=31536000,public,immutable"

          # index.html은 캐시하지 않음
          aws s3 cp packages/dashboard/out/index.html s3://${{ steps.bucket.outputs.name }}/index.html \
            --cache-control "no-cache,no-store,must-revalidate"

  upload-knowledge-base:
    name: Upload Knowledge Base Documents
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    environment: ${{ github.event.inputs.environment || 'dev' }}

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Get Knowledge Base bucket name
        id: bucket
        run: |
          BUCKET_NAME=$(aws cloudformation describe-stacks \
            --stack-name BaepdoongiBedrockStack \
            --query "Stacks[0].Outputs[?ExportName=='BaepdoongiKnowledgeBucketName'].OutputValue" \
            --output text)
          echo "name=$BUCKET_NAME" >> $GITHUB_OUTPUT

      - name: Upload knowledge base documents
        run: |
          aws s3 sync docs/knowledge-base/ s3://${{ steps.bucket.outputs.name }}/knowledge-base/ \
            --delete

      - name: Trigger Knowledge Base sync (수동 필요)
        run: |
          echo "지식 문서가 업로드되었습니다."
          echo "Bedrock Console에서 Knowledge Base 동기화를 수동으로 실행해주세요."
